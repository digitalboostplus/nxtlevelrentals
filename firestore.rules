rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the user's role
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return request.auth != null && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('admin') || hasRole('super-admin');
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Check if user is a landlord
    function isLandlord() {
      return hasRole('landlord');
    }

    // Check if landlord owns a specific property
    function landlordOwnsProperty(propertyId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/properties/$(propertyId)) &&
        get(/databases/$(database)/documents/properties/$(propertyId)).data.landlordId == request.auth.uid;
    }

    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // Properties collection - admins can read/write, tenants/landlords can read
    // Landlords can also read properties they own
    match /properties/{propertyId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Maintenance requests - tenants can create/read their own, admins can read/write all
    // Landlords can read maintenance requests for their properties
    match /maintenanceRequests/{requestId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid ||
        (isLandlord() && landlordOwnsProperty(resource.data.propertyId)) ||
        isAdmin()
      );

      // Allow create if the tenantId matches the auth uid (Tenants creating their own requests)
      allow create: if request.auth != null && request.resource.data.tenantId == request.auth.uid;

      // Allow updates if it's the tenant (read-only for status usually, but keeping simple for now) OR admin
      allow update: if request.auth != null && (
        resource.data.tenantId == request.auth.uid || isAdmin()
      );
    }

    // Lease documents - tenants can read their own, admins can read/write all
    match /leaseDocuments/{documentId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid || isAdmin()
      );
      allow write: if isAdmin();
    }

    // Leases Core Collection - Management of lease terms
    match /leases/{leaseId} {
        // Tenants can read their own leases
        allow read: if request.auth != null && (
            resource.data.tenantId == request.auth.uid ||
            (isLandlord() && resource.data.landlordId == request.auth.uid) ||
            isAdmin()
        );
        
        // Landlords can create leases for themselves
        allow create: if request.auth != null && 
            isLandlord() && 
            request.resource.data.landlordId == request.auth.uid;

        // Landlords can update their own leases
        allow update: if request.auth != null && 
            isLandlord() && 
            resource.data.landlordId == request.auth.uid;
            
        // Admins can do everything
        allow write: if isAdmin();
    }

    // Payment history - tenants can read their own, admins can read/write all
    match /payments/{paymentId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid || isAdmin()
      );
      allow write: if isAdmin();
    }

    // Ledger entries - tenants can read their own, landlords can read for their properties, admins can read/write all
    match /ledger/{entryId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid ||
        resource.data.landlordId == request.auth.uid ||
        isAdmin()
      );
      // Only admins can create/update ledger entries manually
      // Ledger is primarily updated via backend webhooks
      allow create, update: if isAdmin();
    }

    // Payment plans - tenants can read their own, admins can read/write all
    match /paymentPlans/{planId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid || isAdmin()
      );
      allow write: if isAdmin();
    }

    // Stripe customers - users can read their own mapping, only backend should write
    match /stripeCustomers/{tenantId} {
      allow read: if request.auth != null && (
        request.auth.uid == tenantId || isAdmin()
      );
      allow write: if false; // Only backend via Admin SDK
    }

    // Saved payment methods - users can read their own, only backend should write
    match /savedPaymentMethods/{methodId} {
      allow read: if request.auth != null && (
        resource.data.tenantId == request.auth.uid || isAdmin()
      );
      allow write: if false; // Only backend via Admin SDK
    }

    // Notifications - users can only read their own, only update to mark as read
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if false; // Only backend creates notifications
      allow update: if request.auth != null &&
                     resource.data.userId == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      allow delete: if false;
    }

    // FCM tokens - users can only manage their own
    match /fcmTokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Notification preferences - users can only manage their own
    match /notificationPreferences/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ==================== LANDLORD COLLECTIONS ====================

    // Landlords collection - landlords can read/write their own (except sensitive fields), admins can manage all
    match /landlords/{landlordId} {
      // Landlords can read their own profile, admins can read all
      allow read: if isOwner(landlordId) || isAdmin();

      // Only admins can create landlord profiles
      allow create: if isAdmin();

      // Landlords can update their own profile, but NOT sensitive fields
      allow update: if isOwner(landlordId) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['accountStatus', 'totalProperties', 'activeTenants',
                   'monthlyRentTotal', 'createdAt', 'createdBy']);

      // Admins can update any landlord profile including sensitive fields
      allow update: if isAdmin();

      // Only admins can delete landlord profiles
      allow delete: if isAdmin();
    }

    // Landlord documents - landlords can read/upload their own, admins can manage all
    match /landlordDocuments/{documentId} {
      // Landlords can read their own documents, admins can read all
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || isAdmin()
      );

      // Landlords can create their own documents
      allow create: if request.auth != null &&
        request.resource.data.landlordId == request.auth.uid;

      // Landlords can update their own documents, but NOT status/review fields
      allow update: if request.auth != null &&
        resource.data.landlordId == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['status', 'reviewedBy', 'reviewedAt', 'rejectionReason']);

      // Admins can update status and review fields
      allow update: if isAdmin();

      // Only admins can delete documents
      allow delete: if isAdmin();
    }

    // Payouts - landlords can read their own, only admins/backend can create/update
    match /payouts/{payoutId} {
      // Landlords can read their own payouts, admins can read all
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || isAdmin()
      );

      // Only admins/backend can create/update/delete payouts
      allow write: if isAdmin();
    }

    // Landlord expenses - landlords can read their own, only admins can create/update
    match /landlordExpenses/{expenseId} {
      // Landlords can read their own expenses, admins can read all
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || isAdmin()
      );

      // Only admins can create/update/delete expenses
      allow write: if isAdmin();
    }

    // Landlord reports - landlords can read their own, only admins/backend can create/update
    match /landlordReports/{reportId} {
      // Landlords can read their own reports, admins can read all
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || isAdmin()
      );

      // Only admins/backend can create/update/delete reports
      allow write: if isAdmin();
    }
  }
}